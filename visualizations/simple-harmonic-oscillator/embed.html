<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Harmonic Oscillator Lab</title>
    <style>
        :root { --panel: rgba(15, 23, 42, 0.78); }
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; margin: 0; background: radial-gradient(circle at 20% 20%, #1e293b 0%, #0f172a 55%, #020617 100%); color: #f8fafc; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .title { margin: 1.2rem 0 0.8rem; text-align: center; padding: 0 1rem; }
        .title h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.03em; margin: 0.3rem 0; text-shadow: 0 8px 20px rgba(59, 130, 246, 0.22); }
        .title p { color: rgba(226, 232, 240, 0.72); margin: 0 auto; max-width: 720px; font-size: 0.95rem; }
        #wrap { position: relative; width: min(960px, 94vw); border-radius: 0.9rem; border: 1px solid rgba(148, 163, 184, 0.18); box-shadow: 0 18px 40px rgba(15, 23, 42, 0.55); background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); padding: 1.1rem 1.1rem 3.6rem; margin-bottom: 2rem; }
        .layout { display: flex; gap: 1rem; }
        .pane { position: relative; flex: 1; border-radius: 0.75rem; overflow: hidden; border: 1px solid rgba(148, 163, 184, 0.15); background: rgba(15, 23, 42, 0.85); box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.15); }
        canvas { width: 100%; height: 100%; display: block; }
        .pane-label { position: absolute; left: 1rem; top: 0.9rem; padding: 0.25rem 0.75rem; border-radius: 999px; background: rgba(30, 41, 59, 0.75); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(191, 219, 254, 0.88); backdrop-filter: blur(4px); z-index: 1; }
        #stats { position: absolute; right: 1rem; top: 1rem; background: rgba(15, 23, 42, 0.72); padding: 0.55rem 0.85rem; border-radius: 0.6rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.82rem; line-height: 1.6; color: rgba(226, 232, 240, 0.88); border: 1px solid rgba(96, 165, 250, 0.25); z-index: 1;}
        .controls { position: absolute; left: 50%; bottom: 1.2rem; transform: translateX(-50%); display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; justify-content: center; background: transparent; padding: 0.6rem 0.9rem; border-radius: 0.7rem; border: 1px solid rgba(99, 102, 241, 0.22); box-shadow: 0 10px 24px rgba(2, 6, 23, 0.55); }
        .controls > * { pointer-events: auto; }
        .btn { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #f1f5f9; padding: 0.4rem 0.9rem; border: 0; border-radius: 0.5rem; font-weight: 600; font-size: 0.82rem; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; box-shadow: 0 10px 18px rgba(37, 99, 235, 0.28); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 14px 22px rgba(37, 99, 235, 0.38); }
        .btn:active { transform: translateY(1px); }
        .param-group { display: flex; flex-direction: column; gap: 0.28rem; min-width: 150px; }
        .param-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: rgba(226, 232, 240, 0.75); }
        .range { width: 100%; height: 6px; background: rgba(148, 163, 184, 0.28); border-radius: 3px; outline: none; -webkit-appearance: none; appearance: none; cursor: pointer; }
        .range::-webkit-slider-thumb { width: 16px; height: 16px; border-radius: 50%; background: #38bdf8; border: none; box-shadow: 0 0 10px rgba(56, 189, 248, 0.65); -webkit-appearance: none; }
        .range::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: #38bdf8; border: none; box-shadow: 0 0 10px rgba(56, 189, 248, 0.65); }
        @media (max-width: 840px) {
            #wrap { padding-bottom: 5.5rem; }
            .layout { flex-direction: column; }
            .param-group { min-width: 130px; }
            .controls { width: calc(100% - 2.2rem); }
        }
    </style>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]],
                displayMath: [["$$","$$"], ["\\[","\\]"]]
            },
            options: {
                skipHtmlTags: ["script","noscript","style","textarea","pre","code"]
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="title">
        <h1>Simple Harmonic Oscillator Lab</h1>
        <p>Tune the initial displacement, launch velocity, and spring strength. The left panel shows the mass-spring motion and energy data, while the right panel traces the same state through phase space.</p>
    </div>
    <div id="wrap">
        <div class="layout">
            <div class="pane" id="oscPane">
                <canvas id="oscCanvas"></canvas>
                <div class="pane-label">Oscillator</div>
                <div id="stats"></div>
            </div>
            <div class="pane" id="phasePane">
                <canvas id="phaseCanvas"></canvas>
                <div class="pane-label">Phase Portrait</div>
            </div>
        </div>
        <div class="controls">
            <button id="startStopBtn" class="btn">Start</button>
            <button id="resetBtn" class="btn">Reset</button>
            <div class="param-group">
                <label class="param-label">Initial Position x₀ (m): <span id="x0Value">1.00</span></label>
                <input id="x0Slider" class="range" type="range" min="-2" max="2" step="0.01" value="1" />
            </div>
            <div class="param-group">
                <label class="param-label">Initial Velocity v₀ (m/s): <span id="v0Value">0.00</span></label>
                <input id="v0Slider" class="range" type="range" min="-3" max="3" step="0.01" value="0" />
            </div>
            <div class="param-group">
                <label class="param-label">Spring Constant k: <span id="kValue">1.00</span></label>
                <input id="kSlider" class="range" type="range" min="0.5" max="5" step="0.01" value="1" />
            </div>
        </div>
    </div>

    <script>
    // --- Element Selection ---
    const $ = id => document.getElementById(id);
    const oscCanvas = $('oscCanvas');
    const phaseCanvas = $('phaseCanvas');
    const oscCtx = oscCanvas.getContext('2d');
    const phaseCtx = phaseCanvas.getContext('2d');

    const startStopBtn = $('startStopBtn');
    const resetBtn = $('resetBtn');
    const x0Slider = $('x0Slider');
    const v0Slider = $('v0Slider');
    const kSlider = $('kSlider');
    const x0Value = $('x0Value');
    const v0Value = $('v0Value');
    const kValue = $('kValue');
    const statsEl = $('stats');
    
    // --- Global State ---
    const params = {
        k: parseFloat(kSlider.value),
        x0: parseFloat(x0Slider.value),
        v0: parseFloat(v0Slider.value)
    };
    const state = { x: params.x0, v: params.v0, t: 0, m: 1 }; // mass is 1
    let running = false;
    let lastFrameTime = null;
    let accumulator = 0;
    const baseStep = 0.004; // Fixed time step for physics
    const history = [];
    let lastSampleTime = 0;
    const sampleInterval = 0.01;
    const maxHistory = 2200;
    
    // --- Canvas and Physics Setup ---
    function handleResize() {
        const wrapBounds = $('wrap').getBoundingClientRect();
        const padding = 1.1 * parseFloat(getComputedStyle(document.documentElement).fontSize);
        const contentWidth = wrapBounds.width - (padding * 2);
        const isColumnLayout = window.innerWidth < 840;

        let oscW, oscH, phaseW, phaseH;

        if (isColumnLayout) {
            oscW = contentWidth;
            oscH = contentWidth * 0.55;
            phaseW = contentWidth;
            phaseH = contentWidth * 0.55;
        } else {
            oscW = contentWidth * 0.56 - 5;
            phaseW = contentWidth * 0.44 - 5;
            oscH = phaseH = contentWidth * 0.42;
        }

        const setupSingleCanvas = (canvas, ctx, w, h) => {
            const dpr = window.devicePixelRatio || 1;
            canvas.style.width = `${w}px`;
            canvas.style.height = `${h}px`;
            canvas.width = Math.round(w * dpr);
            canvas.height = Math.round(h * dpr);
            ctx.scale(dpr, dpr);
        };
        
        setupSingleCanvas(oscCanvas, oscCtx, oscW, oscH);
        setupSingleCanvas(phaseCanvas, phaseCtx, phaseW, phaseH);
    }
    
    function acceleration(x) {
        return -(params.k / state.m) * x;
    }

    // --- RK4 Integrator for accurate physics ---
    function rk4Step(dt) {
        const x = state.x;
        const v = state.v;
        const k1x = v;
        const k1v = acceleration(x);
        const k2x = v + 0.5 * dt * k1v;
        const k2v = acceleration(x + 0.5 * dt * k1x);
        const k3x = v + 0.5 * dt * k2v;
        const k3v = acceleration(x + 0.5 * dt * k2x);
        const k4x = v + dt * k3v;
        const k4v = acceleration(x + dt * k3x);
        state.x += dt / 6 * (k1x + 2 * k2x + 2 * k3x + k4x);
        state.v += dt / 6 * (k1v + 2 * k2v + 2 * k3v + k4v);
        state.t += dt;
    }

    function advance(frameDt) {
        const clampedDt = Math.min(frameDt, 0.06); // Prevent instability
        accumulator += clampedDt;
        while (accumulator >= baseStep) {
            rk4Step(baseStep);
            recordHistory();
            accumulator -= baseStep;
        }
    }
    
    // --- State and History Management ---
    function recordHistory() {
        if (state.t - lastSampleTime < sampleInterval) return;
        lastSampleTime = state.t;
        history.push({ x: state.x, v: state.v });
        if (history.length > maxHistory) {
            history.splice(0, history.length - maxHistory);
        }
    }

    function resetHistory() {
        history.length = 0;
        lastSampleTime = 0;
    }

    function resetState() {
        state.x = params.x0;
        state.v = params.v0;
        state.t = 0;
        accumulator = 0;
        resetHistory();
        recordHistory();
    }
    
    // --- Drawing Functions ---
    function drawOscillator() {
        const ctx = oscCtx;
        const w = oscCanvas.clientWidth;
        const h = oscCanvas.clientHeight;
        ctx.clearRect(0, 0, w, h);
        
        // Background
        const bgGradient = ctx.createLinearGradient(0, 0, 0, h);
        bgGradient.addColorStop(0, 'rgba(15, 23, 42, 0.95)');
        bgGradient.addColorStop(1, 'rgba(2, 6, 23, 0.95)');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, w, h);

        const wallX = 38, wallW = 26, massW = 90, massH = 76;
        const centerY = h * 0.58;
        const floorY = centerY + massH / 2 + 40;
        const pxPerUnit = (w - wallX - massW - 60) / 4;
        const limitedX = Math.max(-2, Math.min(2, state.x));
        const massCenterX = wallX + 30 + (limitedX + 2) * pxPerUnit;
        const massLeft = massCenterX - massW / 2;

        // Floor and Wall
        ctx.fillStyle = 'rgba(30, 41, 59, 0.8)';
        ctx.fillRect(0, floorY, w, h - floorY);
        ctx.strokeStyle = 'rgba(56, 189, 248, 0.2)';
        ctx.beginPath(); ctx.moveTo(0, floorY); ctx.lineTo(w, floorY); ctx.stroke();
        ctx.fillStyle = 'rgba(30, 41, 59, 0.92)';
        ctx.fillRect(wallX - wallW, centerY - massH, wallW, massH * 2);

        // Spring
        const springStart = wallX + 2;
        const springEnd = massLeft - 8;
        const springLen = Math.max(20, springEnd - springStart);
        ctx.strokeStyle = 'rgba(96, 165, 250, 0.9)';
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(springStart, centerY);
        const coils = 12, amplitude = 14;
        for (let i = 0; i < coils; i++) {
            const ratio = i / coils;
            const x = springStart + ratio * springLen;
            const y = centerY + amplitude * Math.sin(ratio * Math.PI * 2 * 3.5);
            ctx.lineTo(x, y);
        }
        ctx.lineTo(springEnd, centerY);
        ctx.stroke();

        // Mass
        const massGradient = ctx.createLinearGradient(massLeft, 0, massLeft + massW, 0);
        massGradient.addColorStop(0, '#e2e8f0');
        massGradient.addColorStop(1, '#f1f5f9');
        ctx.fillStyle = massGradient;
        ctx.strokeStyle = 'rgba(15, 23, 42, 0.55)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.roundRect(massLeft, centerY - massH / 2, massW, massH, 18);
        ctx.fill();
        ctx.stroke();
        
        ctx.fillStyle = 'rgba(59, 130, 246, 0.92)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace';
        ctx.fillText(`x = ${state.x.toFixed(2)} m`, massLeft + 12, centerY - massH / 2 - 14);
    }

    function drawPhase() {
        const ctx = phaseCtx;
        const w = phaseCanvas.clientWidth;
        const h = phaseCanvas.clientHeight;
        ctx.clearRect(0, 0, w, h);
        
        ctx.fillStyle = 'rgba(2, 6, 23, 0.96)';
        ctx.fillRect(0, 0, w, h);

        const margin = 36;
        const centerX = w / 2;
        const centerY = h / 2;

        let maxAbsX = Math.abs(state.x);
        let maxAbsV = Math.abs(state.v);
        history.forEach(p => {
            if (Math.abs(p.x) > maxAbsX) maxAbsX = Math.abs(p.x);
            if (Math.abs(p.v) > maxAbsV) maxAbsV = Math.abs(p.v);
        });
        const xRange = Math.max(1, maxAbsX * 1.1);
        const vRange = Math.max(1, maxAbsV * 1.1);
        const scaleX = (w / 2 - margin) / xRange;
        const scaleY = (h / 2 - margin) / vRange;

        // Axes
        ctx.strokeStyle = 'rgba(96, 165, 250, 0.75)';
        ctx.lineWidth = 1.4;
        ctx.beginPath();
        ctx.moveTo(margin, centerY); ctx.lineTo(w - margin, centerY); // X-axis
        ctx.moveTo(centerX, margin); ctx.lineTo(centerX, h - margin); // V-axis
        ctx.stroke();
        
        ctx.fillStyle = 'rgba(191, 219, 254, 0.78)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace';
        ctx.fillText('x (m)', w - margin + 6, centerY - 6);
        ctx.fillText('v (m/s)', centerX + 8, margin - 10);
        
        // Trajectory
        if (history.length > 1) {
            ctx.strokeStyle = 'rgba(56, 189, 248, 0.85)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < history.length; i++) {
                const px = centerX + history[i].x * scaleX;
                const py = centerY - history[i].v * scaleY;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.stroke();
        }

        // Current state point
        const currentX = centerX + state.x * scaleX;
        const currentY = centerY - state.v * scaleY;
        ctx.fillStyle = 'rgba(167, 139, 250, 0.95)';
        ctx.beginPath(); ctx.arc(currentX, currentY, 6, 0, Math.PI * 2); ctx.fill();
    }

    function computeEnergy() {
        return 0.5 * params.k * state.x * state.x + 0.5 * state.m * state.v * state.v;
    }

    function updateStats() {
        const energy = computeEnergy();
        const omega = Math.sqrt(params.k / state.m);
        const period = (omega > 0) ? (2 * Math.PI / omega) : Infinity;
        
        const format = (val) => val.toFixed(2).padStart(6, ' ');

        statsEl.innerHTML = `
            t = ${format(state.t)} s<br>
            x = ${format(state.x)} m<br>
            v = ${format(state.v)} m/s<br>
            E = ${format(energy)} J<br>
            ω₀= ${format(omega)} rad/s<br>
            T = ${format(period)} s
        `.replace(/ /g, '&nbsp;');
    }
    
    // --- Main Loop ---
    function frame(timestamp) {
        if (lastFrameTime === null) lastFrameTime = timestamp;
        const dt = (timestamp - lastFrameTime) / 1000;
        lastFrameTime = timestamp;
        
        if (running) {
            advance(dt);
        }
        
        drawOscillator();
        drawPhase();
        updateStats();
        requestAnimationFrame(frame);
    }
    
    // --- Event Listeners ---
    startStopBtn.addEventListener('click', () => {
        running = !running;
        startStopBtn.textContent = running ? 'Pause' : 'Start';
        if (running) {
            lastFrameTime = null; // Reset time to avoid a large jump
        }
    });

    resetBtn.addEventListener('click', () => {
        running = false;
        startStopBtn.textContent = 'Start';
        params.x0 = parseFloat(x0Slider.value);
        params.v0 = parseFloat(v0Slider.value);
        params.k = parseFloat(kSlider.value);
        resetState();
    });

    x0Slider.addEventListener('input', (e) => {
        params.x0 = parseFloat(e.target.value);
        x0Value.textContent = params.x0.toFixed(2);
        if (!running) resetState();
    });

    v0Slider.addEventListener('input', (e) => {
        params.v0 = parseFloat(e.target.value);
        v0Value.textContent = params.v0.toFixed(2);
        if (!running) resetState();
    });

    kSlider.addEventListener('input', (e) => {
        params.k = parseFloat(e.target.value);
        kValue.textContent = params.k.toFixed(2);
        if (!running) {
            // When paused, we still want to see the effect of changing k
            resetState();
        }
    });

    window.addEventListener('resize', () => {
        handleResize();
    });
    
    // --- Initialisation ---
    handleResize();
    resetState();
    requestAnimationFrame(frame);
    </script>
</body>
</html>
